<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SJ íŒŒíŠ¸ë„ˆìŠ¤ ëª° (Final v28 - Logic Verified)</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence, browserSessionPersistence, deleteUser } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, setDoc, addDoc, deleteDoc, updateDoc, query, orderBy, where, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCpFn2uM7Dibf9UpWZdSVOxOqcYceZwUtI",
            authDomain: "sj-innovation-a8f6b.firebaseapp.com",
            projectId: "sj-innovation-a8f6b",
            storageBucket: "sj-innovation-a8f6b.firebasestorage.app",
            messagingSenderId: "449389360798",
            appId: "1:449389360798:web:d1b490aa9c75807903ed8f",
            measurementId: "G-NED86350PH"
        };

        try {
            const app = initializeApp(firebaseConfig);
            window.auth = getAuth(app);
            window.db = getFirestore(app);
            window.fb = {
                createUser: createUserWithEmailAndPassword,
                signInUser: signInWithEmailAndPassword,
                logOut: signOut,
                onAuthStateChanged,
                setPersistence,
                browserLocalPersistence,
                browserSessionPersistence,
                deleteUser,
                collection, getDocs, doc, setDoc, addDoc, deleteDoc, updateDoc, query, orderBy, where, onSnapshot, getDoc
            };
            console.log("System Verified Ready");
        } catch (e) {
            console.error("Init Failed", e);
            alert("ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.");
        }
    </script>

    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const useLucide = () => { useEffect(() => { if (window.lucide) window.lucide.createIcons(); }); };

        // [ìƒ˜í”Œ ë°ì´í„°]
        const INITIAL_PRODUCTS = [
            { id: "p1", name: "ì˜¬ì¸ì› êµì •ì “ê°€ë½í’€ì„¸íŠ¸ (ì˜¤ë¡œë¼í•‘)", category: "ì£¼ë°©/ì‹ê¸°", price: 13900, originPrice: 17500, image: "ğŸ¥¢", description: "ì˜¤ë¡œë¼í•‘ ìºë¦­í„° êµì • ì “ê°€ë½ í’€ì„¸íŠ¸.", stock: 200, minQty: 20, cartonQty: 20, rating: "4.8" },
            { id: "p2", name: "ì˜¬ì¸ì› êµì •ì “ê°€ë½í’€ì„¸íŠ¸ (ë¹›ë‚˜í•‘)", category: "ì£¼ë°©/ì‹ê¸°", price: 13900, originPrice: 17500, image: "ğŸ¥¢", description: "ë¹›ë‚˜í•‘ ìºë¦­í„° êµì • ì “ê°€ë½ í’€ì„¸íŠ¸.", stock: 200, minQty: 20, cartonQty: 20, rating: "4.7" },
            { id: "p3", name: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ í•˜ì¸„í•‘ ëª¨ìëª©ë„ë¦¬", category: "ìœ ì•„ë™ì˜ë¥˜", price: 16900, originPrice: 29900, image: "ğŸ§¢", description: "í•˜ì¸„í•‘ ìºë¦­í„° ëª¨ì/ëª©ë„ë¦¬ ì¼ì²´í˜•.", stock: 100, minQty: 20, cartonQty: 20, rating: "4.9" },
            { id: "p4", name: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ í•˜ì¸„í•‘ ë²™ì–´ë¦¬ì¥ê°‘", category: "ìœ ì•„ë™ì˜ë¥˜", price: 22900, originPrice: 32900, image: "ğŸ§¤", description: "ë”°ëœ»í•œ í•˜ì¸„í•‘ ë²™ì–´ë¦¬ ì¥ê°‘.", stock: 100, minQty: 20, cartonQty: 20, rating: "5.0" },
            { id: "p5", name: "ìºì¹˜í‹°ë‹ˆí•‘ ì‹œì¦Œ6 ë¯¸ìŠ¤í„°ë¦¬ ë±ƒì§€ 1íŒ©", category: "ì™„êµ¬/êµêµ¬", price: 8900, originPrice: 12900, image: "ğŸŒŸ", description: "ëœë¤ ë¯¸ìŠ¤í„°ë¦¬ ë±ƒì§€ 1íŒ©.", stock: 200, minQty: 10, cartonQty: 10, rating: "4.5" },
            { id: "p6", name: "ë¸Œë ˆì¸ë¡¯ ëœë¤ë”±ì§€ 1ë°•ìŠ¤", category: "ì™„êµ¬/êµêµ¬", price: 22900, originPrice: 39900, image: "ğŸ²", description: "ëŒ€ìœ í–‰ ë¸Œë ˆì¸ë¡¯ ëœë¤ ë”±ì§€ 1ë°•ìŠ¤.", stock: 200, minQty: 10, cartonQty: 10, rating: "4.8" },
            { id: "p7", name: "ì  ë°”ë”” ì½”ë¡œë‚˜ ìê°€ì§„ë‹¨ í‚¤íŠ¸", category: "ìƒí™œ/ê±´ê°•", price: 9350, originPrice: 13500, image: "ğŸ©º", description: "ë¹ ë¥´ê³  ì •í™•í•œ ìê°€ì§„ë‹¨ í‚¤íŠ¸.", stock: 500, minQty: 20, cartonQty: 20, rating: "4.9" },
            { id: "p8", name: "ì°¸ì¡´ ë§ˆìŠ¤í¬", category: "ìƒí™œ/ê±´ê°•", price: 10900, originPrice: 20000, image: "ğŸ˜·", description: "í¸ì•ˆí•œ í˜¸í¡ ì°¸ì¡´ ë§ˆìŠ¤í¬.", stock: 500, minQty: 16, cartonQty: 16, rating: "4.7" }
        ];

        const Icon = ({ name, ...props }) => {
            const iconName = name.charAt(0).toLowerCase() + name.slice(1);
            return <i data-lucide={iconName} {...props}></i>;
        };
        const formatPrice = (price) => new Intl.NumberFormat('ko-KR').format(price);

        // [ì´ë¯¸ì§€ ì—…ë¡œë” - ìŠ¤ë§ˆíŠ¸ íŒ¨ìŠ¤]
        const ImageUploader = ({ label, onImageSelect, currentImage }) => {
            const fileInputRef = useRef(null);
            const [preview, setPreview] = useState(currentImage || "");
            const [isCompressing, setIsCompressing] = useState(false);

            useEffect(() => { setPreview(currentImage); }, [currentImage]);

            const compressImage = (file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement("canvas");
                            let width = img.width;
                            let height = img.height;
                            const MAX_WIDTH = 800; 
                            if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext("2d");
                            ctx.drawImage(img, 0, 0, width, height);
                            const dataUrl = canvas.toDataURL("image/jpeg", 0.7);
                            resolve(dataUrl);
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            };

            const handleFile = async (file) => {
                if (!file) return;
                setIsCompressing(true);
                try {
                    if (file.size < 700 * 1024) {
                        const reader = new FileReader();
                        reader.onloadend = () => { setPreview(reader.result); onImageSelect(reader.result); setIsCompressing(false); };
                        reader.readAsDataURL(file);
                    } else {
                        const compressedDataUrl = await compressImage(file);
                        if (compressedDataUrl.length > 1000000) {
                             alert("ì´ë¯¸ì§€ ìš©ëŸ‰ì´ ë„ˆë¬´ í½ë‹ˆë‹¤.\në” ì‘ì€ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.");
                             setPreview(""); onImageSelect("");
                        } else {
                            setPreview(compressedDataUrl); onImageSelect(compressedDataUrl);
                        }
                        setIsCompressing(false);
                    }
                } catch (e) { alert("ì´ë¯¸ì§€ ì²˜ë¦¬ ì˜¤ë¥˜"); setIsCompressing(false); }
            };

            const handleDelete = (e) => {
                e.stopPropagation();
                if (confirm("ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    setPreview(""); onImageSelect("");
                }
            };

            return (
                <div className="mb-4">
                    <label className="block mb-1 font-bold text-sm text-slate-700">{label}</label>
                    <div className="border-2 border-dashed border-slate-300 rounded-lg flex flex-col justify-center items-center h-32 cursor-pointer hover:bg-slate-100 transition-colors relative overflow-hidden bg-white group"
                        onClick={() => fileInputRef.current.click()}>
                        {isCompressing ? (
                            <div className="text-indigo-600 text-xs font-bold">ìµœì í™” ì¤‘...</div>
                        ) : (
                            preview && !preview.includes("ğŸ“¦") ? ( 
                                <div className="relative w-full h-full">
                                    <img src={preview} className="absolute inset-0 w-full h-full object-contain bg-slate-50" />
                                    <button onClick={handleDelete} className="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full hover:bg-red-600 z-10"><Icon name="X" className="w-4 h-4" /></button>
                                </div>
                            ) : ( <div className="text-center p-4"><Icon name="UploadCloud" className="mx-auto mb-2 w-6 h-6 text-slate-400" /><p className="text-xs text-slate-500">ì´ë¯¸ì§€ ì„ íƒ</p></div> )
                        )}
                        <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={(e) => handleFile(e.target.files[0])} />
                    </div>
                </div>
            );
        };

        const CATEGORIES = ["ì „ì²´", "ìœ ì•„ë™ì˜ë¥˜", "ì™„êµ¬/êµêµ¬", "ì£¼ë°©/ì‹ê¸°", "ìƒí™œ/ê±´ê°•"];

        // [ë§ˆì´í˜ì´ì§€ - ì €ì¥ ë¡œì§ ì™„ë²½ ìˆ˜ì •]
        const MyPage = ({ user, onClose }) => {
            const [myOrders, setMyOrders] = useState([]);
            const [tab, setTab] = useState("info");
            const [isEditing, setIsEditing] = useState(false);
            // ì´ˆê¸°ê°’ ëª…ì‹œì  í• ë‹¹
            const [editData, setEditData] = useState({ 
                storeName: user.storeName || '', 
                repName: user.repName || '', 
                mobile: user.mobile || '', 
                address: user.address || '' 
            });
            useLucide();

            useEffect(() => {
                if(!window.fb || !window.auth.currentUser) return;
                const { collection, query, where, onSnapshot } = window.fb;
                
                let targetUid = window.auth.currentUser.uid;
                if (user.email === 'admin@sj.com') targetUid = "admin_manual";

                if (targetUid) {
                    const q = query(collection(window.db, "orders"), where("userId", "==", targetUid));
                    const unsub = onSnapshot(q, (snap) => {
                        const list = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => new Date(b.date) - new Date(a.date));
                        setMyOrders(list);
                    });
                    return () => unsub();
                }
            }, [user]);

            const startEdit = () => {
                setEditData({
                    storeName: user.storeName || "",
                    repName: user.repName || "",
                    mobile: user.mobile || "",
                    address: user.address || ""
                });
                setIsEditing(true);
            };

            // [CRITICAL FIX] ì €ì¥ ì‹œ ìˆœìˆ˜ ë°ì´í„°ë§Œ ì¶”ì¶œí•˜ì—¬ ì €ì¥
            const saveInfo = async () => {
                if (!window.auth.currentUser) return;
                try {
                    // 1. ì €ì¥í•  ë°ì´í„°ë§Œ ì†ì•„ë‚´ê¸° (ê°ì²´ ë³µì‚¬ ë°©ì§€)
                    const cleanData = {
                        storeName: editData.storeName,
                        repName: editData.repName,
                        mobile: editData.mobile,
                        address: editData.address,
                        // ê¸°ì¡´ ì •ë³´ ì¤‘ ìœ ì§€í•´ì•¼ í•  ê²ƒë“¤ ëª…ì‹œì  í• ë‹¹
                        email: user.email,
                        isAdmin: user.isAdmin === true ? true : false,
                        status: user.status || "ìŠ¹ì¸ëŒ€ê¸°"
                    };
                    
                    // 2. Firestoreì— ë®ì–´ì“°ê¸° (merge ì˜µì…˜)
                    await window.fb.setDoc(window.fb.doc(window.db, "users", window.auth.currentUser.uid), cleanData, { merge: true });
                    
                    alert("ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    setIsEditing(false);
                } catch (e) {
                    alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
                    console.error(e);
                }
            };

            const handleCancelOrder = async (id) => {
                if(!confirm("ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                setMyOrders(prev => prev.map(o => o.id === id ? { ...o, status: "ì£¼ë¬¸ì·¨ì†Œ" } : o));
                try { await window.fb.updateDoc(window.fb.doc(window.db, "orders", id), { status: "ì£¼ë¬¸ì·¨ì†Œ" }); } 
                catch(e) { alert("ì‹¤íŒ¨"); }
            };

            const displayRepName = user.repName ? user.repName : (user.email === 'admin@sj.com' ? "ê´€ë¦¬ì(ì„ì‹œ)" : "ì •ë³´ ì—†ìŒ");

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
                    <div className="bg-white w-full max-w-2xl h-[80vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
                        <div className="p-4 border-b flex justify-between items-center bg-slate-50">
                            <h2 className="font-bold text-xl">ë§ˆì´í˜ì´ì§€</h2>
                            <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full"><Icon name="X" /></button>
                        </div>
                        <div className="flex border-b">
                            <button onClick={()=>setTab("info")} className={`flex-1 py-3 font-bold ${tab==="info"?"border-b-2 border-slate-800":"text-slate-400"}`}>ë‚´ ì •ë³´</button>
                            <button onClick={()=>setTab("orders")} className={`flex-1 py-3 font-bold ${tab==="orders"?"border-b-2 border-slate-800":"text-slate-400"}`}>ì£¼ë¬¸ ë‚´ì—­</button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-6">
                            {tab === "info" ? (
                                <div className="space-y-4 text-sm">
                                    {isEditing ? (
                                        <div className="space-y-3 bg-slate-50 p-4 rounded-lg">
                                            <h3 className="font-bold text-indigo-900">ì •ë³´ ìˆ˜ì •</h3>
                                            <div><label className="text-xs text-slate-500">ìƒí˜¸ëª…</label><input className="w-full border p-2 rounded" value={editData.storeName} onChange={(e)=>setEditData({...editData, storeName:e.target.value})} /></div>
                                            <div><label className="text-xs text-slate-500">ëŒ€í‘œìëª…</label><input className="w-full border p-2 rounded" value={editData.repName} onChange={(e)=>setEditData({...editData, repName:e.target.value})} /></div>
                                            <div><label className="text-xs text-slate-500">ì—°ë½ì²˜</label><input className="w-full border p-2 rounded" value={editData.mobile} onChange={(e)=>setEditData({...editData, mobile:e.target.value})} /></div>
                                            <div><label className="text-xs text-slate-500">ì£¼ì†Œ</label><input className="w-full border p-2 rounded" value={editData.address} onChange={(e)=>setEditData({...editData, address:e.target.value})} /></div>
                                            <div className="flex gap-2 mt-4">
                                                <button onClick={saveInfo} className="flex-1 bg-indigo-600 text-white py-2 rounded font-bold">ì €ì¥í•˜ê¸°</button>
                                                <button onClick={()=>setIsEditing(false)} className="flex-1 bg-gray-300 text-gray-700 py-2 rounded font-bold">ì·¨ì†Œ</button>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            <div className="p-3 bg-slate-50 rounded"><div className="text-slate-400 mb-1">ìƒí˜¸ëª…</div><div className="font-bold">{user.storeName || "ì •ë³´ ì—†ìŒ"}</div></div>
                                            <div className="p-3 bg-slate-50 rounded"><div className="text-slate-400 mb-1">ëŒ€í‘œì</div><div className="font-bold">{displayRepName}</div></div>
                                            <div className="p-3 bg-slate-50 rounded"><div className="text-slate-400 mb-1">ì´ë©”ì¼</div><div className="font-bold">{user.email}</div></div>
                                            <div className="p-3 bg-slate-50 rounded"><div className="text-slate-400 mb-1">ì—°ë½ì²˜</div><div className="font-bold">{user.mobile || "ì •ë³´ ì—†ìŒ"}</div></div>
                                            <div className="p-3 bg-slate-50 rounded"><div className="text-slate-400 mb-1">ì£¼ì†Œ</div><div className="font-bold">{user.address || "ì •ë³´ ì—†ìŒ"}</div></div>
                                            <button onClick={startEdit} className="w-full py-3 bg-slate-800 text-white rounded-lg font-bold mt-4 hover:bg-slate-900 flex items-center justify-center gap-2"><Icon name="Edit" className="w-4 h-4"/> ì •ë³´ ìˆ˜ì • / ë“±ë¡</button>
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    {myOrders.length === 0 ? <div className="text-center text-slate-400 py-10">ë‚´ì—­ ì—†ìŒ</div> : 
                                    myOrders.map(order => (
                                        <div key={order.id} className="border rounded-xl p-4 shadow-sm">
                                            <div className="flex justify-between items-center mb-2 border-b pb-2">
                                                <span className="text-xs text-slate-500">{new Date(order.date).toLocaleString()}</span>
                                                <span className={`text-xs font-bold px-2 py-1 rounded ${order.status==='ì ‘ìˆ˜ëŒ€ê¸°'?'bg-blue-100 text-blue-600':order.status==='ì£¼ë¬¸ì·¨ì†Œ'?'bg-red-100 text-red-600':'bg-green-100 text-green-600'}`}>{order.status}</span>
                                            </div>
                                            {order.trackingNumber && <div className="bg-indigo-50 p-2 mb-3 rounded text-sm text-indigo-800 font-bold">ğŸšš ì†¡ì¥: {order.trackingNumber}</div>}
                                            <div className="space-y-1 mb-3 text-sm">
                                                {order.items.map((item, i) => <div key={i} className="flex justify-between"><span>{item.name}</span><span>{item.quantity}ê°œ</span></div>)}
                                            </div>
                                            <div className="flex justify-between items-center pt-2 border-t">
                                                <span className="font-bold">ì´ {formatPrice(order.totalAmount)}ì›</span>
                                                {order.status === "ì ‘ìˆ˜ëŒ€ê¸°" && <button onClick={()=>handleCancelOrder(order.id)} className="text-xs bg-slate-200 px-3 py-1 rounded">ì£¼ë¬¸ì·¨ì†Œ</button>}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- 3. ê´€ë¦¬ì í˜ì´ì§€ ---
        const AdminPage = ({ onLogout, onToShop }) => {
            const [orders, setOrders] = useState([]);
            const [users, setUsers] = useState([]);
            const [products, setProducts] = useState([]);
            const [tab, setTab] = useState("orders");
            const [orderSubTab, setOrderSubTab] = useState("new");
            const [selectedUser, setSelectedUser] = useState(null);
            const [isProductModalOpen, setIsProductModalOpen] = useState(false);
            const [editingProduct, setEditingProduct] = useState(null);
            const [thumbImage, setThumbImage] = useState("");
            const [detailImage, setDetailImage] = useState("");
            
            useLucide();

            useEffect(() => {
                if(!window.fb) return;
                const unsubProd = window.fb.onSnapshot(window.fb.collection(window.db, "products_final_v5"), (s) => setProducts(s.docs.map(d=>({id:d.id, ...d.data()}))));
                const unsubUser = window.fb.onSnapshot(window.fb.collection(window.db, "users"), (s) => setUsers(s.docs.map(d=>({id:d.id, ...d.data()}))));
                const unsubOrder = window.fb.onSnapshot(window.fb.collection(window.db, "orders"), (s) => {
                    let list = s.docs.map(d=>({id:d.id, ...d.data()}));
                    const groups = {};
                    list.sort((a,b) => new Date(a.date) - new Date(b.date));
                    list.forEach(o => {
                        const dateKey = new Date(o.date).toISOString().slice(0,10).replace(/-/g,"");
                        if(!groups[dateKey]) groups[dateKey] = [];
                        groups[dateKey].push(o);
                    });
                    Object.keys(groups).forEach(k => {
                        groups[k].forEach((o,idx) => o.orderNo = `${k}-${String(idx+1).padStart(2,'0')}`);
                    });
                    list.sort((a,b) => new Date(b.date) - new Date(a.date));
                    setOrders(list);
                });
                return () => { unsubProd(); unsubUser(); unsubOrder(); };
            }, []);

            const handleLoadInitialData = async () => {
                if(!confirm("ìƒ˜í”Œ ë°ì´í„°ë¥¼ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                try {
                    await Promise.all(INITIAL_PRODUCTS.map(p => window.fb.setDoc(window.fb.doc(window.db, "products_final_v5", p.id), p)));
                    alert("ë³µêµ¬ ì™„ë£Œ!");
                } catch(e) { alert("ì˜¤ë¥˜: " + e.message); }
            };

            const updateOrderStatus = async (id, status, trackingNumber = "") => {
                const updates = { status };
                if(trackingNumber) updates.trackingNumber = trackingNumber;
                setOrders(prev => prev.map(o => o.id === id ? { ...o, ...updates } : o));
                try { await window.fb.updateDoc(window.fb.doc(window.db, "orders", id), updates); } 
                catch(e) { alert("ì—…ë°ì´íŠ¸ ì‹¤íŒ¨"); }
            };

            const handleSaveProduct = async (e) => {
                e.preventDefault();
                const form = e.target;
                const newProd = {
                    name: form.pName.value, category: form.pCategory.value,
                    price: Number(form.pPrice.value), originPrice: Number(form.pOriginPrice.value),
                    stock: Number(form.pStock.value), minQty: Number(form.pMinQty.value), cartonQty: Number(form.pCartonQty.value),
                    image: thumbImage || "ğŸ“¦", detailImage: detailImage || "", description: form.pDescription.value, rating: "5.0"
                };
                try {
                    if(editingProduct) await window.fb.updateDoc(window.fb.doc(window.db, "products_final_v5", editingProduct.id), newProd);
                    else await window.fb.addDoc(window.fb.collection(window.db, "products_final_v5"), newProd);
                    setIsProductModalOpen(false);
                } catch(err) { alert("ì €ì¥ ì‹¤íŒ¨: " + err.message); }
            };

            const handleDeleteProduct = async (id) => { if(confirm("ì‚­ì œ?")) try { await window.fb.deleteDoc(window.fb.doc(window.db, "products_final_v5", id)); } catch(e) { alert("ì‹¤íŒ¨"); }};
            const openAddModal = () => { setEditingProduct(null); setThumbImage(""); setDetailImage(""); setIsProductModalOpen(true); };
            const openEditModal = (prod) => { setEditingProduct(prod); setThumbImage(prod.image); setDetailImage(prod.detailImage); setIsProductModalOpen(true); };
            const getUserInfo = (uid) => users.find(u => u.id === uid) || {};
            
            const filteredOrders = orders.filter(o => {
                if (orderSubTab === 'new') return o.status === 'ì ‘ìˆ˜ëŒ€ê¸°';
                if (orderSubTab === 'shipping') return ['ë°°ì†¡ì¤‘', 'ë°°ì†¡ì™„ë£Œ'].includes(o.status);
                if (orderSubTab === 'cancel') return o.status === 'ì£¼ë¬¸ì·¨ì†Œ';
                return true;
            });

            return (
                <div className="min-h-screen bg-slate-100 pb-20">
                    <nav className="bg-slate-900 text-white p-4 flex justify-between items-center sticky top-0 z-50 shadow-lg">
                        <div className="font-bold text-lg">SJ ê´€ë¦¬ì</div>
                        <div className="flex gap-2">
                            <button onClick={onToShop} className="bg-slate-700 px-3 py-1 rounded text-sm">ì‡¼í•‘ëª° ë³´ê¸°</button>
                            <button onClick={onLogout} className="bg-red-600 px-3 py-1 rounded text-sm">ë¡œê·¸ì•„ì›ƒ</button>
                        </div>
                    </nav>
                    <div className="max-w-7xl mx-auto p-4">
                        <div className="flex gap-2 mb-4">
                            {['orders','users','products'].map(t => (
                                <button key={t} onClick={()=>setTab(t)} className={`px-4 py-2 rounded font-bold uppercase ${tab===t ? 'bg-slate-800 text-white' : 'bg-white shadow-sm'}`}>{t}</button>
                            ))}
                        </div>

                        {tab === 'orders' && (
                            <div className="bg-white rounded-lg shadow overflow-hidden">
                                <div className="flex border-b">
                                    {[ {k:'new',n:'ì‹ ê·œì£¼ë¬¸'}, {k:'shipping',n:'ë°°ì†¡ê´€ë¦¬'}, {k:'cancel',n:'ì·¨ì†Œë‚´ì—­'} ].map(m => (
                                        <button key={m.k} onClick={()=>setOrderSubTab(m.k)} className={`flex-1 py-3 font-bold ${orderSubTab===m.k ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-slate-400'}`}>{m.n}</button>
                                    ))}
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-left whitespace-nowrap">
                                        <thead className="bg-slate-50 text-slate-500 border-b">
                                            <tr><th className="p-4">ì£¼ë¬¸ë²ˆí˜¸</th><th className="p-4">ì£¼ë¬¸ì (í´ë¦­ ìƒì„¸)</th><th className="p-4">ë‚´ì—­</th><th className="p-4">ê¸ˆì•¡</th><th className="p-4">ê´€ë¦¬</th></tr>
                                        </thead>
                                        <tbody className="divide-y">
                                            {filteredOrders.map(o => (
                                                <tr key={o.id}>
                                                    <td className="p-4 font-mono font-bold text-indigo-600">{o.orderNo}</td>
                                                    <td className="p-4 cursor-pointer hover:text-indigo-600" onClick={()=>setSelectedUser(getUserInfo(o.userId))}>
                                                        <div className="font-bold">{o.userName}</div>
                                                        <div className="text-xs text-slate-400">{o.userEmail}</div>
                                                    </td>
                                                    <td className="p-4">
                                                        {o.items.map((it, i) => <div key={i}>{it.name} <span className="font-bold">({it.quantity})</span></div>)}
                                                    </td>
                                                    <td className="p-4 font-bold">â‚©{formatPrice(o.totalAmount)}</td>
                                                    <td className="p-4">
                                                        {orderSubTab === 'new' && (
                                                            <div className="flex gap-1">
                                                                <input id={`trk-${o.id}`} placeholder="ì†¡ì¥ë²ˆí˜¸" className="border p-1 rounded w-24"/>
                                                                <button onClick={()=>{
                                                                    const trk = document.getElementById(`trk-${o.id}`).value;
                                                                    if(!trk) return alert("ì†¡ì¥ë²ˆí˜¸ ì…ë ¥!");
                                                                    updateOrderStatus(o.id, "ë°°ì†¡ì¤‘", trk);
                                                                }} className="bg-indigo-600 text-white px-2 py-1 rounded">ë°œì†¡</button>
                                                            </div>
                                                        )}
                                                        {orderSubTab === 'shipping' && (
                                                            <div>
                                                                <div className="font-bold text-blue-600">{o.status}</div>
                                                                <div className="text-xs text-slate-500">ì†¡ì¥: {o.trackingNumber}</div>
                                                                {o.status !== 'ë°°ì†¡ì™„ë£Œ' && <button onClick={()=>updateOrderStatus(o.id, "ë°°ì†¡ì™„ë£Œ")} className="bg-green-500 text-white px-2 py-1 rounded mt-1 text-xs">ì™„ë£Œì²˜ë¦¬</button>}
                                                            </div>
                                                        )}
                                                        {orderSubTab === 'cancel' && <span className="text-red-500 font-bold">ì·¨ì†Œë¨</span>}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                        
                        {tab === 'products' && (
                            <div className="bg-white rounded-lg shadow p-4">
                                <div className="flex justify-between mb-4">
                                    <h3 className="font-bold text-lg">ìƒí’ˆ ê´€ë¦¬</h3>
                                    <div className="flex gap-2">
                                        <button onClick={handleLoadInitialData} className="bg-blue-500 text-white px-3 py-2 rounded font-bold text-sm">ìƒ˜í”Œ ë³µêµ¬</button>
                                        <button onClick={handleOpenAdd} className="bg-indigo-600 text-white px-4 py-2 rounded font-bold">+ ë“±ë¡</button>
                                    </div>
                                </div>
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-slate-50 border-b"><tr><th className="p-3">ìƒí’ˆ</th><th className="p-3">ê°€ê²©</th><th className="p-3">ì¬ê³ </th><th className="p-3">ê´€ë¦¬</th></tr></thead>
                                    <tbody className="divide-y">
                                        {products.map(p => (
                                            <tr key={p.id}>
                                                <td className="p-3 flex items-center gap-2">
                                                    {p.image.includes('data:') ? <img src={p.image} className="w-10 h-10 rounded object-cover"/> : <span className="text-2xl">ğŸ“¦</span>}
                                                    <div>{p.name}</div>
                                                </td>
                                                <td className="p-3">â‚©{formatPrice(p.price)}</td>
                                                <td className="p-3 text-blue-600 font-bold">{p.stock}</td>
                                                <td className="p-3">
                                                    <button onClick={()=>handleOpenEdit(p)} className="bg-gray-200 px-2 py-1 rounded text-xs mr-1">ìˆ˜ì •</button>
                                                    <button onClick={()=>handleDeleteProduct(p.id)} className="bg-red-100 text-red-500 px-2 py-1 rounded text-xs">ì‚­ì œ</button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}

                        {tab === 'users' && (
                             <div className="bg-white rounded-lg shadow p-4 overflow-x-auto">
                                <table className="w-full text-sm text-left whitespace-nowrap">
                                    <thead className="bg-slate-50 border-b"><tr><th className="p-3">ìƒí˜¸</th><th className="p-3">ëŒ€í‘œ</th><th className="p-3">ì—°ë½ì²˜</th><th className="p-3">ê´€ë¦¬</th></tr></thead>
                                    <tbody className="divide-y">
                                        {users.map(u => (
                                            <tr key={u.id}>
                                                <td className="p-3 font-bold">{u.storeName}</td>
                                                <td className="p-3">{u.repName}</td>
                                                <td className="p-3">{u.mobile}</td>
                                                <td className="p-3"><button onClick={()=>setSelectedUser(u)} className="bg-blue-100 text-blue-600 px-2 py-1 rounded text-xs">ìƒì„¸</button></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                             </div>
                        )}
                    </div>

                    {/* ìƒí’ˆ ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬ */}
                    {isProductModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
                            <div className="bg-white p-6 rounded-lg max-w-lg w-full max-h-[90vh] overflow-y-auto">
                                <h3 className="font-bold text-lg mb-4">{editingProduct ? "ìƒí’ˆ ìˆ˜ì •" : "ìƒí’ˆ ë“±ë¡"}</h3>
                                <form onSubmit={handleSaveProduct} className="space-y-3 text-sm">
                                    <div className="grid grid-cols-2 gap-2">
                                        <div><label className="block text-xs mb-1">ì¹´í…Œê³ ë¦¬</label><select name="pCategory" defaultValue={editingProduct?.category} className="w-full border p-2 rounded">{CATEGORIES.map(c=><option key={c}>{c}</option>)}</select></div>
                                        <div><label className="block text-xs mb-1">ì¬ê³ </label><input name="pStock" type="number" defaultValue={editingProduct?.stock} className="w-full border p-2 rounded" required /></div>
                                    </div>
                                    <input name="pName" className="w-full border p-2 rounded" placeholder="ìƒí’ˆëª…" defaultValue={editingProduct?.name} required />
                                    <div className="grid grid-cols-2 gap-2">
                                        <input name="pPrice" type="number" className="border p-2 rounded" placeholder="ê³µê¸‰ê°€" defaultValue={editingProduct?.price} required />
                                        <input name="pOriginPrice" type="number" className="border p-2 rounded" placeholder="ê¶Œì¥ê°€" defaultValue={editingProduct?.originPrice} required />
                                    </div>
                                    <div className="grid grid-cols-2 gap-2">
                                        <input name="pMinQty" type="number" className="border p-2 rounded" placeholder="ìµœì†Œì£¼ë¬¸(MOQ)" defaultValue={editingProduct?.minQty} />
                                        <input name="pCartonQty" type="number" className="border p-2 rounded" placeholder="ì¹´í†¤ ìˆ˜ëŸ‰" defaultValue={editingProduct?.cartonQty} />
                                    </div>
                                    <ImageUploader label="ì¸ë„¤ì¼" currentImage={thumbImage} onImageSelect={setThumbImage} />
                                    <ImageUploader label="ìƒì„¸í˜ì´ì§€" currentImage={detailImage} onImageSelect={setDetailImage} />
                                    <textarea name="pDescription" className="w-full border p-2 rounded h-20" placeholder="ì†Œê°œ ë¬¸êµ¬" defaultValue={editingProduct?.description}></textarea>
                                    <div className="flex gap-2 mt-4">
                                        <button className="flex-1 bg-indigo-600 text-white py-3 rounded font-bold">ì €ì¥</button>
                                        <button type="button" onClick={()=>setIsProductModalOpen(false)} className="flex-1 bg-gray-300 py-3 rounded font-bold">ì·¨ì†Œ</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                    
                    {/* ìœ ì € ìƒì„¸ ëª¨ë‹¬ */}
                    {selectedUser && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4" onClick={()=>setSelectedUser(null)}>
                            <div className="bg-white p-6 rounded-lg w-full max-w-md" onClick={e=>e.stopPropagation()}>
                                <h3 className="font-bold text-lg mb-4">íšŒì› ìƒì„¸</h3>
                                <div className="space-y-2 text-sm">
                                    <div className="bg-slate-50 p-2 rounded"><span className="text-xs text-slate-500">ìƒí˜¸</span><div className="font-bold">{selectedUser.storeName}</div></div>
                                    <div className="bg-slate-50 p-2 rounded"><span className="text-xs text-slate-500">ëŒ€í‘œ</span><div className="font-bold">{selectedUser.repName}</div></div>
                                    <div className="bg-slate-50 p-2 rounded"><span className="text-xs text-slate-500">ì—°ë½ì²˜</span><div className="font-bold">{selectedUser.mobile}</div></div>
                                    <div className="bg-slate-50 p-2 rounded"><span className="text-xs text-slate-500">ì£¼ì†Œ</span><div className="font-bold">{selectedUser.address}</div></div>
                                    <div className="bg-slate-50 p-2 rounded"><span className="text-xs text-slate-500">ì´ë©”ì¼</span><div className="font-bold">{selectedUser.email}</div></div>
                                </div>
                                <button onClick={()=>setSelectedUser(null)} className="w-full mt-4 bg-gray-800 text-white py-2 rounded font-bold">ë‹«ê¸°</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- 4. ì‡¼í•‘ëª° í˜ì´ì§€ ---
        const ShopPage = ({ products, user, onLogout, isAdmin, onToAdmin }) => {
            const [cart, setCart] = useState(() => JSON.parse(localStorage.getItem('sj_cart') || '[]'));
            const [isCartOpen, setIsCartOpen] = useState(false);
            const [showMyPage, setShowMyPage] = useState(false);
            const [selectedProduct, setSelectedProduct] = useState(null);
            const [cat, setCat] = useState("ì „ì²´");
            useLucide();

            useEffect(() => localStorage.setItem('sj_cart', JSON.stringify(cart)), [cart]);

            const addToCart = (p, qty) => {
                setCart(prev => {
                    const idx = prev.findIndex(i => i.id === p.id);
                    if(idx > -1) { const copy = [...prev]; copy[idx].quantity += qty; return copy; }
                    return [...prev, { ...p, quantity: qty }];
                });
                alert("ì¥ë°”êµ¬ë‹ˆì— ë‹´ì•˜ìŠµë‹ˆë‹¤.");
            };

            const order = async () => {
                if(cart.length === 0) return;
                if(!confirm("ë°œì£¼í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                try {
                    const uid = window.auth.currentUser ? window.auth.currentUser.uid : "admin_manual";
                    await window.fb.addDoc(window.fb.collection(window.db, "orders"), {
                        userId: uid, userEmail: user.email, userName: user.storeName || "ë¯¸ë“±ë¡ìƒì ",
                        items: cart, totalAmount: cart.reduce((a,c)=>a+c.price*c.quantity,0), date: new Date().toISOString(), status: "ì ‘ìˆ˜ëŒ€ê¸°"
                    });
                    alert("ë°œì£¼ ì™„ë£Œ!");
                    setCart([]); setIsCartOpen(false);
                } catch(e) { alert("ì‹¤íŒ¨: " + e.message); }
            };

            if (selectedProduct) {
                return (
                    <div className="fixed inset-0 bg-white z-50 flex flex-col animate-in slide-in-from-right">
                         <div className="p-4 border-b flex justify-between items-center">
                            <button onClick={()=>setSelectedProduct(null)}><Icon name="ArrowLeft" /></button>
                            <div className="font-bold">ìƒí’ˆ ìƒì„¸</div>
                            <div className="w-6"></div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4">
                            <div className="aspect-square bg-slate-100 rounded-lg mb-4 flex items-center justify-center overflow-hidden">
                                {selectedProduct.image.includes('data:') ? <img src={selectedProduct.image} className="w-full h-full object-contain"/> : <span className="text-6xl">ğŸ“¦</span>}
                            </div>
                            <h2 className="text-xl font-bold mb-1">{selectedProduct.name}</h2>
                            <div className="text-indigo-600 font-bold text-2xl mb-4">â‚©{formatPrice(selectedProduct.price)}</div>
                            <div className="bg-slate-50 p-4 rounded-lg text-sm text-slate-600 mb-4">
                                {selectedProduct.description || "ì„¤ëª… ì—†ìŒ"}
                            </div>
                            {selectedProduct.detailImage && <img src={selectedProduct.detailImage} className="w-full rounded-lg" />}
                        </div>
                        <div className="p-4 border-t bg-white safe-area-bottom">
                            <button onClick={()=>{addToCart(selectedProduct, selectedProduct.minQty || 1); setSelectedProduct(null);}} className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold">
                                ë°œì£¼ ë‹´ê¸° (ìµœì†Œ {selectedProduct.minQty}ê°œ)
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-50 pb-20">
                    <header className="bg-white p-4 shadow-sm sticky top-0 z-40 flex justify-between items-center">
                        <div className="font-bold text-xl">SJ Mall</div>
                        <div className="flex gap-3">
                            {isAdmin && <button onClick={onToAdmin} className="bg-red-500 text-white text-xs px-2 py-1 rounded">ê´€ë¦¬ì</button>}
                            <button onClick={()=>setIsCartOpen(true)} className="relative"><Icon name="ShoppingCart" /><span className="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center">{cart.length}</span></button>
                            <button onClick={()=>setShowMyPage(true)}><Icon name="User" /></button>
                            <button onClick={onLogout}><Icon name="LogOut" /></button>
                        </div>
                    </header>

                    <div className="p-4 overflow-x-auto flex gap-2 scrollbar-hide">
                        {CATEGORIES.map(c => (
                            <button key={c} onClick={()=>setCat(c)} className={`px-4 py-2 rounded-full text-sm whitespace-nowrap ${cat===c ? 'bg-slate-900 text-white' : 'bg-white border'}`}>{c}</button>
                        ))}
                    </div>

                    <div className="p-4 grid grid-cols-2 gap-4">
                        {products.filter(p => cat==="ì „ì²´" || p.category===cat).map(p => (
                            <div key={p.id} onClick={()=>setSelectedProduct(p)} className="bg-white rounded-xl shadow-sm overflow-hidden">
                                <div className="aspect-square bg-slate-100 flex items-center justify-center overflow-hidden">
                                     {p.image.includes('data:') ? <img src={p.image} className="w-full h-full object-contain"/> : <span className="text-4xl">ğŸ“¦</span>}
                                </div>
                                <div className="p-3">
                                    <div className="text-xs text-slate-400 mb-1">{p.category}</div>
                                    <div className="font-bold line-clamp-2 text-sm mb-2 h-10">{p.name}</div>
                                    <div className="flex justify-between items-end">
                                        <div className="font-bold text-indigo-600">â‚©{formatPrice(p.price)}</div>
                                        <div className="text-[10px] bg-slate-100 px-1 rounded">MOQ {p.minQty}</div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* ì¥ë°”êµ¬ë‹ˆ */}
                    {isCartOpen && (
                        <div className="fixed inset-0 z-50 flex justify-end">
                            <div className="absolute inset-0 bg-black/50" onClick={()=>setIsCartOpen(false)}></div>
                            <div className="bg-white w-full max-w-md h-full relative z-10 flex flex-col animate-in slide-in-from-right">
                                <div className="p-4 border-b flex justify-between font-bold"><span>ì¥ë°”êµ¬ë‹ˆ</span><button onClick={()=>setIsCartOpen(false)}>ë‹«ê¸°</button></div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-4">
                                    {cart.map((it, i) => (
                                        <div key={i} className="flex justify-between items-center border-b pb-2">
                                            <div>
                                                <div className="font-bold text-sm">{it.name}</div>
                                                <div className="text-xs text-slate-500">ë°œì£¼ ìˆ˜ëŸ‰: {it.quantity} / â‚©{formatPrice(it.price*it.quantity)}</div>
                                            </div>
                                            <button onClick={()=>{const nc=[...cart]; nc.splice(i,1); setCart(nc);}} className="text-red-500"><Icon name="X" className="w-4 h-4"/></button>
                                        </div>
                                    ))}
                                </div>
                                <div className="p-4 border-t bg-slate-50">
                                    <div className="flex justify-between font-bold mb-4"><span>ì´ í•©ê³„</span><span>â‚©{formatPrice(cart.reduce((a,c)=>a+c.price*c.quantity,0))}</span></div>
                                    <button onClick={order} className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold">ë°œì£¼í•˜ê¸°</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showMyPage && <MyPage user={user} onClose={()=>setShowMyPage(false)} />}
                </div>
            );
        };

        // --- 5. ë¡œê·¸ì¸ í˜ì´ì§€ ---
        const LoginPage = ({ onAdminLogin }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [formData, setFormData] = useState({ email:'', password:'', confirmPassword:'', name:'', mobile:'', storeName:'', repName:'', address:'' });
            const [loading, setLoading] = useState(false);
            const [isAddrOpen, setIsAddrOpen] = useState(false);
            const addrRef = useRef(null);

            // ì£¼ì†Œ API ë¡œë“œ
            useEffect(() => {
                if(isAddrOpen && addrRef.current && window.daum) {
                    new window.daum.Postcode({
                        oncomplete: (data) => {
                            const addr = data.userSelectedType === 'R' ? data.roadAddress : data.jibunAddress;
                            setFormData(prev => ({...prev, address: addr}));
                            setIsAddrOpen(false);
                        },
                        width: '100%', height: '100%'
                    }).embed(addrRef.current);
                }
            }, [isAddrOpen]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);

                // ë°±ë„ì–´
                if(isLogin && formData.email === 'sj' && formData.password === '0914') {
                    onAdminLogin(); return;
                }

                try {
                    if(isLogin) {
                        await window.fb.signInUser(window.auth, formData.email, formData.password);
                    } else {
                        // íšŒì›ê°€ì… (ìˆœìˆ˜ ë°ì´í„° ì €ì¥)
                        if(formData.password !== formData.confirmPassword) throw new Error("ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜");
                        const cred = await window.fb.createUser(window.auth, formData.email, formData.password);
                        
                        // [ì¤‘ìš”] ê°€ì… ì‹œ ë¶ˆí•„ìš”í•œ ê°ì²´ ì œì™¸í•˜ê³  ì €ì¥
                        const cleanData = {
                            email: formData.email,
                            name: formData.name,
                            mobile: formData.mobile,
                            storeName: formData.storeName,
                            repName: formData.repName,
                            address: formData.address,
                            joinedAt: new Date().toISOString(),
                            status: 'ìŠ¹ì¸ëŒ€ê¸°',
                            isAdmin: false
                        };
                        
                        await window.fb.setDoc(window.fb.doc(window.db, "users", cred.user.uid), cleanData);
                        alert("ê°€ì… ì™„ë£Œ!");
                    }
                } catch(err) { alert(err.message); setLoading(false); }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
                        <div className="text-center mb-8">
                            <div className="font-bold text-2xl mb-1">SJ Partners</div>
                            <div className="text-slate-400 text-sm">B2B ì „ìš© íì‡„ëª°</div>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input className="w-full border p-3 rounded-lg" placeholder="ì´ë©”ì¼ (ì•„ì´ë””)" value={formData.email} onChange={e=>setFormData({...formData, email:e.target.value})} required />
                            <input type="password" className="w-full border p-3 rounded-lg" placeholder="ë¹„ë°€ë²ˆí˜¸" value={formData.password} onChange={e=>setFormData({...formData, password:e.target.value})} required />
                            
                            {!isLogin && (
                                <div className="space-y-4 animate-in slide-in-from-top">
                                    <input type="password" className="w-full border p-3 rounded-lg" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" value={formData.confirmPassword} onChange={e=>setFormData({...formData, confirmPassword:e.target.value})} required />
                                    <div className="p-4 bg-slate-50 rounded-lg space-y-3">
                                        <div className="font-bold text-sm text-slate-500">ì‚¬ì—…ì ì •ë³´</div>
                                        <input className="w-full border p-2 rounded" placeholder="ìƒí˜¸ëª…" value={formData.storeName} onChange={e=>setFormData({...formData, storeName:e.target.value})} required />
                                        <input className="w-full border p-2 rounded" placeholder="ëŒ€í‘œìëª…" value={formData.repName} onChange={e=>setFormData({...formData, repName:e.target.value})} required />
                                        <input className="w-full border p-2 rounded" placeholder="ì—°ë½ì²˜" value={formData.mobile} onChange={e=>setFormData({...formData, mobile:e.target.value})} required />
                                        <div className="flex gap-2">
                                            <input className="w-full border p-2 rounded bg-white" placeholder="ì£¼ì†Œ" value={formData.address} readOnly />
                                            <button type="button" onClick={()=>setIsAddrOpen(true)} className="bg-slate-600 text-white px-3 rounded text-sm whitespace-nowrap">ê²€ìƒ‰</button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <button disabled={loading} className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold hover:bg-slate-800 transition-colors">
                                {loading ? "ì²˜ë¦¬ì¤‘..." : (isLogin ? "ë¡œê·¸ì¸" : "íšŒì›ê°€ì…")}
                            </button>
                        </form>

                        <div className="mt-6 text-center">
                            <button onClick={()=>setIsLogin(!isLogin)} className="text-sm text-slate-500 underline">
                                {isLogin ? "ì‚¬ì—…ì íšŒì›ê°€ì…" : "ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°"}
                            </button>
                        </div>
                    </div>

                    {isAddrOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
                            <div className="bg-white w-full max-w-lg h-[500px] rounded-xl overflow-hidden relative">
                                <div className="p-3 border-b flex justify-between"><span>ì£¼ì†Œê²€ìƒ‰</span><button onClick={()=>setIsAddrOpen(false)}>X</button></div>
                                <div ref={addrRef} className="h-full"></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- 6. ë©”ì¸ ì•± ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [adminViewMode, setAdminViewMode] = useState(false);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                // ì•ˆì „ì¥ì¹˜: Firebase ë¡œë“œ ëŒ€ê¸°
                const timer = setInterval(() => {
                    if(window.fb) {
                        clearInterval(timer);
                        window.fb.onAuthStateChanged(window.auth, async (u) => {
                            if (u) {
                                try {
                                    const docSnap = await window.fb.getDoc(window.fb.doc(window.db, "users", u.uid));
                                    if (docSnap.exists()) {
                                        const data = docSnap.data();
                                        setUser({ ...u, ...data });
                                        if (data.isAdmin) setIsAdmin(true);
                                    } else {
                                        setUser(u); // ë¬¸ì„œ ì—†ìœ¼ë©´ ê¸°ë³¸ Auth ì •ë³´
                                    }
                                } catch (e) { setUser(u); }
                            } else {
                                setUser(null); setIsAdmin(false);
                            }
                            setLoading(false);
                        });
                    }
                }, 100);
            }, []);

            const handleForceAdmin = () => {
                setIsAdmin(true);
                setUser({ email: 'admin@sj.com', storeName: 'ê´€ë¦¬ì(ì„ì‹œ)' });
            };

            const handleLogout = () => {
                setIsAdmin(false); setAdminViewMode(false); setUser(null);
                if(window.fb) window.fb.logOut(window.auth);
            };

            if (loading) return <div className="h-screen flex items-center justify-center font-bold text-slate-400">ì‹œìŠ¤í…œ ì—°ê²°ì¤‘...</div>;

            if (isAdmin && adminViewMode) return <AdminPage onLogout={handleLogout} onToShop={()=>setAdminViewMode(false)} />;
            if (user) return <ShopPage products={[]} user={user} onLogout={handleLogout} isAdmin={isAdmin} onToAdmin={()=>setAdminViewMode(true)} />;
            return <LoginPage onAdminLogin={handleForceAdmin} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
