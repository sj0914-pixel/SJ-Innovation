<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SJ íŒŒíŠ¸ë„ˆìŠ¤ ëª° (Real DB)</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, setDoc, updateDoc, query, where } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCpFn2uM7Dibf9UpWZdSVOxOqcYceZwUtI",
            authDomain: "sj-innovation-a8f6b.firebaseapp.com",
            projectId: "sj-innovation-a8f6b",
            storageBucket: "sj-innovation-a8f6b.firebasestorage.app",
            messagingSenderId: "449389360798",
            appId: "1:449389360798:web:d1b490aa9c75807903ed8f",
            measurementId: "G-NED86350PH"
        };

        try {
            const app = initializeApp(firebaseConfig);
            window.auth = getAuth(app);
            window.db = getFirestore(app); // ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°
            
            // ì „ì—­ ë³€ìˆ˜ë¡œ í•¨ìˆ˜ ë“±ë¡ (Reactì—ì„œ ì“°ê¸° ìœ„í•´)
            window.createUser = createUserWithEmailAndPassword;
            window.signInUser = signInWithEmailAndPassword;
            window.logOut = signOut;
            
            // Firestore í•¨ìˆ˜ ë“±ë¡
            window.fs = { collection, getDocs, doc, setDoc, updateDoc, query, where };
            
            console.log("Firebase & Firestore Connected");
        } catch (e) {
            console.error("Connection Error", e);
        }
    </script>

    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icon = ({ name, ...props }) => {
            const iconName = name.charAt(0).toLowerCase() + name.slice(1);
            return <i data-lucide={iconName} {...props}></i>;
        };

        // --- ì´ˆê¸° ë°ì´í„° (DBê°€ ë¹„ì—ˆì„ ë•Œë§Œ ì‚¬ìš©) ---
        const DEFAULT_PRODUCTS = [
            { id: "p1", name: "ìºì¹˜í‹°ë‹ˆí•‘ í•˜ì¸„í•‘ ë°©í•œìš©í’ˆ", category: "ìœ ì•„ë™ì˜ë¥˜", price: 11900, originPrice: 23000, stock: 100, image: "ğŸ§£" },
            { id: "p2", name: "í‹°ë‹ˆí•‘ ë§ˆìŠ¤í¬ ì‹œì¦Œ3 (20ë§¤)", category: "ìƒí™œ/ê±´ê°•", price: 12900, originPrice: 15900, stock: 500, image: "ğŸ˜·" },
            { id: "p3", name: "ìŠˆíŒ…ìŠ¤íƒ€ í•˜ì¸„í•‘ ìœ ì•„ í„¸ëª©ë„ë¦¬", category: "ìœ ì•„ë™ì˜ë¥˜", price: 12900, originPrice: 21900, stock: 30, image: "ğŸ§£" },
            { id: "p4", name: "ì´íƒˆë¦¬ì•ˆ ë¸Œë ˆì¸ë¡¯ ëœë¤ ë”±ì§€", category: "ì™„êµ¬/êµêµ¬", price: 22900, originPrice: 39900, stock: 200, image: "ğŸ²" },
            { id: "p5", name: "ìì„ ê¸€ì í•œê¸€í”ŒëŸ¬ìŠ¤", category: "ì™„êµ¬/êµêµ¬", price: 39900, originPrice: 49900, stock: 15, image: "ğŸ§²" },
            { id: "p6", name: "êµì • ì “ê°€ë½ ìŠ¤í‘¼ í¬í¬ ì„¸íŠ¸", category: "ì£¼ë°©/ì‹ê¸°", price: 13900, originPrice: 17500, stock: 150, image: "ğŸ¥¢" },
            { id: "p7", name: "ë…¼ìŠ¬ë¦½ ìŠ¤í…ì»µ (ì™•ìí•‘)", category: "ì£¼ë°©/ì‹ê¸°", price: 9900, originPrice: 15000, stock: 80, image: "ğŸ¥›" },
            { id: "p8", name: "ìœ ì•„ ì–´ë¦°ì´ ì•ˆì‹¬ë½ ìŠ¤íŠ¸ë© ë³´í‹€", category: "ì£¼ë°©/ì‹ê¸°", price: 8900, originPrice: 12500, stock: 120, image: "ğŸ¼" },
            { id: "p9", name: "ë””ì €íŠ¸ìƒµ ìì„ ì†Œê¿‰ë†€ì´", category: "ì™„êµ¬/êµêµ¬", price: 27000, originPrice: 35000, stock: 40, image: "ğŸ°" },
            { id: "p10", name: "KF94 í†¤ì—…í• ë¸”ë™ë¼ë²¨ ë§ˆìŠ¤í¬", category: "ìƒí™œ/ê±´ê°•", price: 10900, originPrice: 20000, stock: 1000, image: "ğŸ˜·" }
        ];

        // ------------------------------------------
        // [ë¡œê·¸ì¸ í˜ì´ì§€] - íšŒì›ê°€ì… ì‹œ DBì— ì €ì¥
        // ------------------------------------------
        const LoginPage = ({ onAdminLogin }) => {
            const [isLoginMode, setIsLoginMode] = useState(true);
            const [loading, setLoading] = useState(false);
            const [formData, setFormData] = useState({ email: '', password: '', confirmPassword: '', storeName: '', phone: '' });

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);

                // â˜… ê´€ë¦¬ì ë¡œê·¸ì¸ (sj / 0914) â˜…
                if (isLoginMode && formData.email === 'sj' && formData.password === '0914') {
                    onAdminLogin();
                    return;
                }

                if (!window.auth) { alert("ì—°ê²° ì¤‘..."); setLoading(false); return; }

                try {
                    if (isLoginMode) {
                        await window.signInUser(window.auth, formData.email, formData.password);
                    } else {
                        // íšŒì›ê°€ì… ë¡œì§
                        if (formData.password !== formData.confirmPassword) {
                            alert("ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜"); setLoading(false); return;
                        }
                        
                        // 1. ì¸ì¦(Auth) ìƒì„±
                        const userCredential = await window.createUser(window.auth, formData.email, formData.password);
                        const user = userCredential.user;

                        // 2. DB(Firestore)ì— íšŒì›ì •ë³´ ì €ì¥ (ì‹¤ì œ ì €ì¥!)
                        const { doc, setDoc } = window.fs;
                        await setDoc(doc(window.db, "users", user.uid), {
                            email: user.email,
                            storeName: formData.storeName,
                            phone: formData.phone,
                            joinedAt: new Date().toISOString(),
                            status: "ìŠ¹ì¸ëŒ€ê¸°" // ê¸°ë³¸ ìƒíƒœ
                        });

                        alert("íšŒì›ê°€ì… ì™„ë£Œ! ìë™ìœ¼ë¡œ ë¡œê·¸ì¸ë©ë‹ˆë‹¤.");
                    }
                } catch (err) {
                    console.error(err);
                    alert("ì˜¤ë¥˜: " + err.message);
                    setLoading(false);
                }
            };

            const handleChange = (e) => setFormData({ ...formData, [e.target.name]: e.target.value });

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white rounded-2xl shadow-xl w-full max-w-md p-8">
                        <div className="text-center mb-6">
                            <h1 className="text-2xl font-bold">{isLoginMode ? "SJ íŒŒíŠ¸ë„ˆ ë¡œê·¸ì¸" : "ì‚¬ì—…ì íšŒì›ë“±ë¡"}</h1>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-3">
                            <input name="email" type="text" placeholder="ì•„ì´ë”” (ì´ë©”ì¼)" className="w-full p-3 border rounded-lg" onChange={handleChange} required />
                            <input name="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" className="w-full p-3 border rounded-lg" onChange={handleChange} required />
                            
                            {!isLoginMode && (
                                <>
                                    <input name="confirmPassword" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" className="w-full p-3 border rounded-lg" onChange={handleChange} required />
                                    <input name="storeName" type="text" placeholder="ìƒí˜¸ëª… (ì˜ˆ: ëŒ€ë°•ë¬¸êµ¬)" className="w-full p-3 border rounded-lg" onChange={handleChange} required />
                                    <input name="phone" type="text" placeholder="ì—°ë½ì²˜" className="w-full p-3 border rounded-lg" onChange={handleChange} required />
                                </>
                            )}

                            <button type="submit" disabled={loading} className="w-full bg-slate-800 text-white py-4 rounded-xl font-bold mt-4">
                                {loading ? "ì²˜ë¦¬ì¤‘..." : (isLoginMode ? "ë¡œê·¸ì¸" : "íšŒì›ê°€ì… ì™„ë£Œ")}
                            </button>
                        </form>
                        <button onClick={() => setIsLoginMode(!isLoginMode)} className="w-full text-center mt-4 text-sm underline">
                            {isLoginMode ? "íšŒì›ê°€ì… í•˜ê¸°" : "ë¡œê·¸ì¸ í•˜ê¸°"}
                        </button>
                    </div>
                </div>
            );
        };

        // ------------------------------------------
        // [ê´€ë¦¬ì í˜ì´ì§€] - DB ì—°ë™ë¨
        // ------------------------------------------
        const AdminPage = ({ onLogout }) => {
            const [products, setProducts] = useState([]);
            const [users, setUsers] = useState([]);
            const [tab, setTab] = useState("products");

            // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ì‹¤ì‹œê°„)
            useEffect(() => {
                const fetchData = async () => {
                    const { collection, getDocs } = window.fs;
                    
                    // 1. ìƒí’ˆ ë¶ˆëŸ¬ì˜¤ê¸°
                    const prodSnap = await getDocs(collection(window.db, "products"));
                    const prodList = prodSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setProducts(prodList);

                    // 2. íšŒì› ë¶ˆëŸ¬ì˜¤ê¸°
                    const userSnap = await getDocs(collection(window.db, "users"));
                    const userList = userSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setUsers(userList);
                };
                fetchData();
            }, []);

            // ì¬ê³  ìˆ˜ì • (DB ë°˜ì˜)
            const updateStock = async (id, newStock) => {
                const { doc, updateDoc } = window.fs;
                const stockVal = parseInt(newStock);
                
                // í™”ë©´ ë¨¼ì € ê°±ì‹  (ë¹ ë¥¸ ë°˜ì‘)
                setProducts(prev => prev.map(p => p.id === id ? { ...p, stock: stockVal } : p));

                // ì‹¤ì œ DB ì—…ë°ì´íŠ¸
                try {
                    await updateDoc(doc(window.db, "products", id), { stock: stockVal });
                } catch(e) {
                    alert("ì¬ê³  ì €ì¥ ì‹¤íŒ¨: " + e.message);
                }
            };

            return (
                <div className="min-h-screen bg-slate-100">
                    <nav className="bg-slate-900 text-white p-4 flex justify-between items-center">
                        <span className="font-bold text-lg">SJ ADMIN (ì‹¤ì œ DB ì—°ë™ë¨)</span>
                        <button onClick={onLogout} className="bg-slate-700 px-4 py-2 rounded">ë¡œê·¸ì•„ì›ƒ</button>
                    </nav>
                    <div className="p-6 max-w-6xl mx-auto">
                        <div className="flex gap-4 mb-6">
                            <button onClick={() => setTab("products")} className={`px-4 py-2 rounded font-bold ${tab==="products"?"bg-white text-black":"bg-slate-200 text-slate-500"}`}>ìƒí’ˆ ê´€ë¦¬</button>
                            <button onClick={() => setTab("users")} className={`px-4 py-2 rounded font-bold ${tab==="users"?"bg-white text-black":"bg-slate-200 text-slate-500"}`}>íšŒì› ê´€ë¦¬</button>
                        </div>

                        {tab === "products" ? (
                            <div className="bg-white rounded-xl shadow p-4">
                                <table className="w-full text-left">
                                    <thead><tr className="border-b"><th className="p-3">ìƒí’ˆëª…</th><th className="p-3">ì¬ê³ </th><th className="p-3">ê°€ê²©</th></tr></thead>
                                    <tbody>
                                        {products.map(p => (
                                            <tr key={p.id} className="border-b hover:bg-slate-50">
                                                <td className="p-3">{p.name}</td>
                                                <td className="p-3">
                                                    <input type="number" defaultValue={p.stock} 
                                                        onBlur={(e) => updateStock(p.id, e.target.value)}
                                                        className="border p-1 w-20 rounded text-center" />
                                                </td>
                                                <td className="p-3">â‚©{p.price.toLocaleString()}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        ) : (
                            <div className="bg-white rounded-xl shadow p-4">
                                <table className="w-full text-left">
                                    <thead><tr className="border-b"><th className="p-3">ìƒí˜¸ëª…</th><th className="p-3">ì´ë©”ì¼</th><th className="p-3">ì—°ë½ì²˜</th><th className="p-3">ê°€ì…ì¼</th></tr></thead>
                                    <tbody>
                                        {users.map(u => (
                                            <tr key={u.id} className="border-b hover:bg-slate-50">
                                                <td className="p-3 font-bold">{u.storeName || "ë¯¸ì…ë ¥"}</td>
                                                <td className="p-3">{u.email}</td>
                                                <td className="p-3">{u.phone || "-"}</td>
                                                <td className="p-3 text-sm text-slate-500">{u.joinedAt?.split('T')[0]}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // ------------------------------------------
        // [ì‡¼í•‘ëª° í˜ì´ì§€] - DB ìƒí’ˆ ë¶ˆëŸ¬ì˜¤ê¸°
        // ------------------------------------------
        const ShopPage = ({ user, onLogout }) => {
            const [products, setProducts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [cart, setCart] = useState([]);
            const [isCartOpen, setIsCartOpen] = useState(false);

            useEffect(() => {
                const initShop = async () => {
                    const { collection, getDocs, doc, setDoc } = window.fs;
                    const prodRef = collection(window.db, "products");
                    const snapshot = await getDocs(prodRef);

                    if (snapshot.empty) {
                        // â˜… DBê°€ ë¹„ì—ˆìœ¼ë©´ ì´ˆê¸° ë°ì´í„° ìë™ ì—…ë¡œë“œ (ìµœì´ˆ 1íšŒ ì‹¤í–‰)
                        console.log("DB ì´ˆê¸°í™” ì¤‘...");
                        await Promise.all(DEFAULT_PRODUCTS.map(p => setDoc(doc(window.db, "products", p.id), p)));
                        setProducts(DEFAULT_PRODUCTS);
                    } else {
                        // DB ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                        const list = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                        setProducts(list);
                    }
                    setLoading(false);
                };
                initShop();
            }, []);

            const addToCart = (product) => {
                setCart(prev => {
                    const idx = prev.findIndex(p => p.id === product.id);
                    if(idx > -1) {
                        const newCart = [...prev]; newCart[idx].quantity += 1; return newCart;
                    }
                    return [...prev, { ...product, quantity: 1 }];
                });
                alert("ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ë¨");
            };

            if(loading) return <div className="h-screen flex items-center justify-center">ìƒí’ˆ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>;

            return (
                <div className="min-h-screen bg-slate-50 pb-20">
                    <header className="sticky top-0 bg-white shadow px-4 h-16 flex justify-between items-center z-40">
                        <div className="font-bold">SJ Innovation</div>
                        <div className="flex gap-4">
                            <button onClick={() => setIsCartOpen(true)}>ì¥ë°”êµ¬ë‹ˆ ({cart.length})</button>
                            <button onClick={onLogout}>ë¡œê·¸ì•„ì›ƒ</button>
                        </div>
                    </header>
                    <main className="p-4 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 max-w-7xl mx-auto">
                        {products.map(p => (
                            <div key={p.id} className="bg-white rounded-xl shadow overflow-hidden p-4 hover:shadow-lg transition">
                                <div className="text-4xl text-center mb-4">{p.image}</div>
                                <div className="font-bold truncate">{p.name}</div>
                                <div className="flex justify-between mt-2 items-end">
                                    <span className="font-bold">â‚©{p.price.toLocaleString()}</span>
                                    <span className="text-xs text-slate-400">ì¬ê³ : {p.stock}</span>
                                </div>
                                <button onClick={() => addToCart(p)} className="w-full mt-3 bg-slate-100 py-2 rounded text-sm hover:bg-slate-200">ë‹´ê¸°</button>
                            </div>
                        ))}
                    </main>
                    {isCartOpen && (
                        <div className="fixed inset-0 z-50 flex justify-end">
                            <div className="absolute inset-0 bg-black/30" onClick={()=>setIsCartOpen(false)}></div>
                            <div className="bg-white w-full max-w-md h-full relative p-4 flex flex-col">
                                <h2 className="font-bold text-lg mb-4">ì¥ë°”êµ¬ë‹ˆ</h2>
                                <div className="flex-1 overflow-y-auto space-y-4">
                                    {cart.map((item,i)=>(
                                        <div key={i} className="flex justify-between border-b pb-2">
                                            <div>{item.name} x {item.quantity}</div>
                                            <div>â‚©{(item.price*item.quantity).toLocaleString()}</div>
                                        </div>
                                    ))}
                                </div>
                                <button className="bg-slate-800 text-white py-4 rounded font-bold mt-4">ë°œì£¼í•˜ê¸°</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                lucide.createIcons();
                // 1ì´ˆ ë’¤ Auth ì²´í¬ (íŒŒì´ì–´ë² ì´ìŠ¤ ë¡œë”© ëŒ€ê¸°)
                const timer = setTimeout(() => {
                    if (window.auth) {
                        window.auth.onAuthStateChanged((u) => {
                            if (!isAdmin) setUser(u);
                            setLoading(false);
                        });
                    }
                }, 1000);
                return () => clearTimeout(timer);
            }, [isAdmin]);

            const handleAdminLogin = () => {
                setIsAdmin(true);
                setUser({ email: 'admin' });
            };

            const handleLogout = () => {
                if (isAdmin) { setIsAdmin(false); setUser(null); }
                else { window.logOut(window.auth); }
            };

            if (loading) return <div className="h-screen flex items-center justify-center">ì‹œìŠ¤í…œ ì—°ê²°ì¤‘...</div>;
            if (isAdmin) return <AdminPage onLogout={handleLogout} />;
            if (user) return <ShopPage user={user} onLogout={handleLogout} />;
            return <LoginPage onAdminLogin={handleAdminLogin} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
